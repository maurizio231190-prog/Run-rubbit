<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Cascata POP ‚Äî 5 corsie (Fullscreen)</title>
  <style>
    :root{
      --sky1:#b9f3ff;
      --sky2:#ffd6f3;
      --sky3:#fff2b8;
      --ink:#1f1f1f;
      --line:#0000001a;
      --shadow: 0 18px 40px rgba(0,0,0,.18);
    }
    *{ box-sizing:border-box; }
    html, body{
      margin:0; height:100%;
      font-family: ui-rounded, "SF Pro Rounded", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:#000;
      overflow:hidden;
      touch-action:none;
    }

    /* FULLSCREEN ARENA */
    .arena{
      position:fixed;
      inset:0;
      overflow:hidden;
      background:
        radial-gradient(900px 520px at 18% 10%, var(--sky1), transparent 60%),
        radial-gradient(900px 520px at 82% 12%, var(--sky2), transparent 60%),
        radial-gradient(900px 520px at 50% 98%, var(--sky3), transparent 60%),
        linear-gradient(180deg, #fff, #f7fbff);
    }

    /* strobo soft */
    .arena::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(620px 380px at 50% 18%, rgba(255,255,255,.35), transparent 60%),
                  radial-gradient(900px 520px at 50% 60%, rgba(255,120,200,.12), transparent 65%),
                  radial-gradient(900px 520px at 20% 70%, rgba(60,180,255,.10), transparent 65%),
                  radial-gradient(900px 520px at 80% 70%, rgba(70,255,170,.08), transparent 65%);
      opacity:.55;
      animation: strobe 1.1s infinite ease-in-out;
      pointer-events:none;
    }
    @keyframes strobe{
      0%{opacity:.38}
      25%{opacity:.65}
      55%{opacity:.42}
      78%{opacity:.72}
      100%{opacity:.40}
    }

    /* Nuvole */
    .cloud{
      position:absolute;
      top:18px;
      width:220px; height:70px;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(0,0,0,.06);
      border-radius:999px;
      box-shadow: 0 18px 28px rgba(0,0,0,.07);
      opacity:.85;
      animation: float 12s linear infinite;
      pointer-events:none;
    }
    .cloud::before,.cloud::after{
      content:"";
      position:absolute;
      background:rgba(255,255,255,.78);
      border:1px solid rgba(0,0,0,.05);
      border-radius:999px;
    }
    .cloud::before{ width:90px; height:60px; left:18px; top:-18px; }
    .cloud::after { width:110px; height:70px; left:90px; top:-26px; }
    @keyframes float{
      0%{transform: translateX(-320px)}
      100%{transform: translateX(calc(100vw + 320px))}
    }

    /* Portale bianco (zona da cui ‚Äúescono‚Äù) */
    .portal{
      position:absolute;
      left:50%; top:8%;
      width:min(520px, 92vw);
      height:min(240px, 40vh);
      transform:translateX(-50%);
      background:
        radial-gradient(closest-side at 50% 60%, rgba(255,255,255,.98), rgba(255,255,255,.55) 28%, transparent 70%),
        radial-gradient(closest-side at 50% 55%, rgba(255,240,200,.55), transparent 65%);
      filter: blur(.2px);
      opacity:.95;
      pointer-events:none;
    }

    /* corsie (5) */
    .lanes{
      position:absolute; inset:0;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      pointer-events:none;
      opacity:.26;
    }
    .lane{
      border-left:2px dashed rgba(0,0,0,.08);
    }
    .lane:first-child{border-left:none}

    /* pavimento mattonelle */
    .floor{
      position:absolute; left:0; right:0; bottom:0;
      height:170px;
      background:
        linear-gradient(180deg, rgba(255,255,255,0), rgba(0,0,0,.10)),
        repeating-linear-gradient(90deg, rgba(255,255,255,.10) 0 2px, transparent 2px 38px),
        repeating-linear-gradient(0deg, rgba(255,255,255,.08) 0 2px, transparent 2px 34px);
      pointer-events:none;
    }

    /* numeri 1..5 sul pavimento */
    .laneNums{
      position:absolute;
      left:0; right:0;
      bottom:18px;
      display:flex;
      justify-content:space-between;
      padding:0 10vw;
      pointer-events:none;
      z-index:10;
      opacity:.85;
      font-weight:1000;
      color:rgba(255,255,255,.92);
      text-shadow: 0 10px 18px rgba(0,0,0,.35);
      letter-spacing:.5px;
    }
    .laneNums span{
      width:1.2em;
      text-align:center;
      font-size:18px;
    }

    /* arena inner + shake */
    .arenaInner{
      position:absolute; inset:0;
      transform-origin:50% 60%;
      will-change: transform;
      z-index:5;
    }
    .shake{ animation: shake .18s ease both; }
    @keyframes shake{
      0%{transform: translate(0,0) rotate(0deg)}
      25%{transform: translate(6px,1px) rotate(0.6deg)}
      55%{transform: translate(-6px,0px) rotate(-0.6deg)}
      100%{transform: translate(0,0) rotate(0deg)}
    }

    /* player piccolo in basso */
    .player{
      position:absolute;
      bottom:34px;
      width:96px; height:96px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: left .08s cubic-bezier(.2,.9,.25,1);
      z-index:8;
      will-change:left, transform;
      filter: drop-shadow(0 18px 18px rgba(0,0,0,.18));
      user-select:none;
    }
    .player.bop{ animation: bop .16s ease both; }
    @keyframes bop{
      0%{transform: scale(1)}
      50%{transform: scale(1.10)}
      100%{transform: scale(1)}
    }
    .avatar{
      width:92px; height:92px;
      border-radius:999px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(0,0,0,.10);
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 12px 22px rgba(0,0,0,.12);
      overflow:hidden;
    }
    .avatar svg{ width:92px; height:92px; display:block; }

    /* falling items */
    .falling{
      position:absolute;
      top:-120px;
      width:96px; height:96px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:64px;
      filter: drop-shadow(0 14px 12px rgba(0,0,0,.14));
      z-index:7;
      will-change: transform;
      user-select:none;
    }

    /* particelle */
    .particle{
      position:absolute;
      width:10px; height:10px;
      border-radius:999px;
      opacity:.95;
      z-index:12;
      pointer-events:none;
      animation: puff 520ms ease-out forwards;
    }
    @keyframes puff{
      0%{transform: translate(0,0) scale(.8); opacity:1}
      100%{transform: translate(var(--dx), var(--dy)) scale(0.2); opacity:0}
    }

    /* micro HUD invisibile (solo debug): premere H su desktop */
    .hud{
      position:absolute; left:10px; top:10px;
      padding:8px 10px;
      border-radius:14px;
      background:rgba(255,255,255,.65);
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 12px 22px rgba(0,0,0,.10);
      font-size:12px; font-weight:900;
      z-index:20;
      opacity:0;
      transition: opacity .15s ease;
      pointer-events:none;
    }
    .hud.on{ opacity:.9; }
  </style>
</head>

<body>
  <div class="arena" id="arena">
    <div class="cloud" style="left:-320px; top:18px; animation-duration: 14s;"></div>
    <div class="cloud" style="left:-380px; top:88px; width:260px; height:78px; opacity:.70; animation-duration: 18s;"></div>

    <div class="portal"></div>

    <div class="lanes" aria-hidden="true">
      <div class="lane"></div><div class="lane"></div><div class="lane"></div><div class="lane"></div><div class="lane"></div>
    </div>

    <div class="arenaInner" id="inner">
      <div class="player" id="player"><div class="avatar" id="avatar"></div></div>
    </div>

    <div class="laneNums" aria-hidden="true">
      <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
    </div>

    <div class="floor"></div>

    <div class="hud" id="hud">Punti: <span id="score">0</span> ¬∑ Vite: <span id="lives">3</span></div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const arena  = $("arena");
  const inner  = $("inner");
  const player = $("player");
  const avatar = $("avatar");
  const hud    = $("hud");
  const scoreEl= $("score");
  const livesEl= $("lives");

  const LANES = 5;

  // ===== Personaggi: BIMBA + CONIGLIO =====
  const SVG = {
    girl: `
      <svg viewBox="0 0 140 140" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="70" cy="70" r="62" fill="#ffd1dc" stroke="rgba(0,0,0,.10)" stroke-width="2"/>
        <path d="M18 70c0-34 28-56 52-56s52 22 52 56c-14-12-28-18-52-18S32 58 18 70z"
              fill="#2c1b14" opacity=".95"/>
        <path d="M24 78c4 28 22 46 46 46s42-18 46-46c-14 10-30 14-46 14S38 88 24 78z"
              fill="#2c1b14" opacity=".92"/>
        <ellipse cx="52" cy="78" rx="14" ry="12" fill="#fff"/>
        <ellipse cx="88" cy="78" rx="14" ry="12" fill="#fff"/>
        <circle cx="56" cy="80" r="5.5" fill="#222"/>
        <circle cx="92" cy="80" r="5.5" fill="#222"/>
        <path d="M56 104c10 9 22 9 32 0" fill="none" stroke="#2a2a2a" stroke-width="5" stroke-linecap="round"/>
        <circle cx="40" cy="96" r="6" fill="#ff79b0" opacity=".45"/>
        <circle cx="100" cy="96" r="6" fill="#ff79b0" opacity=".45"/>
      </svg>
    `,
    bunny: `
      <svg viewBox="0 0 140 140" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <radialGradient id="b" cx="30%" cy="25%" r="80%">
            <stop offset="0" stop-color="#ffffff"/>
            <stop offset="1" stop-color="#f0fbff"/>
          </radialGradient>
        </defs>
        <circle cx="70" cy="78" r="56" fill="url(#b)" stroke="rgba(0,0,0,.10)" stroke-width="2"/>
        <ellipse cx="44" cy="24" rx="18" ry="34" fill="#ffffff" stroke="rgba(0,0,0,.10)" stroke-width="2" transform="rotate(-12 44 24)"/>
        <ellipse cx="96" cy="24" rx="18" ry="34" fill="#ffffff" stroke="rgba(0,0,0,.10)" stroke-width="2" transform="rotate(12 96 24)"/>
        <ellipse cx="44" cy="26" rx="9" ry="22" fill="#ffbcd2" opacity=".85" transform="rotate(-12 44 26)"/>
        <ellipse cx="96" cy="26" rx="9" ry="22" fill="#ffbcd2" opacity=".85" transform="rotate(12 96 26)"/>
        <ellipse cx="54" cy="78" rx="13" ry="11" fill="#fff"/>
        <ellipse cx="86" cy="78" rx="13" ry="11" fill="#fff"/>
        <circle cx="58" cy="80" r="5.2" fill="#222"/>
        <circle cx="90" cy="80" r="5.2" fill="#222"/>
        <circle cx="60" cy="77" r="2" fill="#fff" opacity=".9"/>
        <circle cx="92" cy="77" r="2" fill="#fff" opacity=".9"/>
        <ellipse cx="70" cy="92" rx="7" ry="6" fill="#ff7aa8" opacity=".9"/>
        <path d="M62 98c6 6 10 6 16 0" fill="none" stroke="#2a2a2a" stroke-width="5" stroke-linecap="round"/>
        <circle cx="44" cy="92" r="6" fill="#8ad8ff" opacity=".45"/>
        <circle cx="96" cy="92" r="6" fill="#8ad8ff" opacity=".45"/>
      </svg>
    `
  };

  const characters = ["girl", "bunny"];
  let charIndex = 0;

  function setCharacter(idx){
    charIndex = (idx + characters.length) % characters.length;
    avatar.innerHTML = SVG[characters[charIndex]];
    bopPlayer();
  }

  // ===== Oggetti (solo testo / emoji) =====
  // buoni: üçï ‚≠ê
  // cattivo: üëÆ (poliziotto "solo testo")
  const ITEMS = [
    { glyph:"üçï", kind:"good"  },
    { glyph:"‚≠ê", kind:"bonus" },
    { glyph:"üëÆ", kind:"bad"   }
  ];

  // ===== State =====
  let lane = 2; // 0..4
  let running = true;
  let score = 0;
  let lives = 3;

  let level = 1;
  let speedMult = 1.0;

  const falling = [];
  let lastSpawnAt = 0;
  let lastTs = 0;

  // debug HUD toggle
  let hudOn = false;
  function toggleHud(){
    hudOn = !hudOn;
    hud.classList.toggle("on", hudOn);
  }

  // ===== Posizionamento player =====
  function laneToLeftPx(l){
    const w = arena.clientWidth;
    const laneW = w / LANES;
    const x = (l * laneW) + (laneW / 2);
    return x - (player.clientWidth / 2);
  }
  function placePlayer(){
    player.style.left = `${laneToLeftPx(lane)}px`;
  }

  function bopPlayer(){
    player.classList.remove("bop");
    void player.offsetWidth;
    player.classList.add("bop");
  }

  function shakeArena(){
    inner.classList.remove("shake");
    void inner.offsetWidth;
    inner.classList.add("shake");
  }

  // ===== Particelle =====
  function burst(x, y, palette){
    const n = 12;
    for(let i=0;i<n;i++){
      const p = document.createElement("div");
      p.className = "particle";
      const ang = Math.random() * Math.PI * 2;
      const dist = 30 + Math.random()*60;
      const dx = Math.cos(ang) * dist;
      const dy = Math.sin(ang) * dist - 10;
      p.style.left = (x - 5) + "px";
      p.style.top  = (y - 5) + "px";
      p.style.setProperty("--dx", dx + "px");
      p.style.setProperty("--dy", dy + "px");
      p.style.background = palette[Math.floor(Math.random()*palette.length)];
      arena.appendChild(p);
      setTimeout(()=>p.remove(), 600);
    }
  }

  function updateHud(){
    scoreEl.textContent = String(score);
    livesEl.textContent = String(lives);
  }

  // ===== Difficolt√† soft =====
  function updateLeveling(){
    const target = 1 + Math.floor(score / 120);
    if(target > level){
      level = target;
      speedMult = 1 + (level - 1) * 0.08;
    }
  }

  function spawnCadenceMs(){
    const ms = 780 / speedMult;
    return Math.max(360, ms);
  }

  function minSpawnGapMs(){
    return Math.max(240, 520 - level * 18);
  }

  function fallPxPerFrame(){
    return (2.35 * speedMult) + (level * 0.08);
  }

  function spawnOne(){
    const now = performance.now();
    if(now - lastSpawnAt < minSpawnGapMs()) return;
    lastSpawnAt = now;

    // peso: pi√π buoni, meno cattivi
    const r = Math.random();
    let item = ITEMS[0]; // üçï
    if(r < 0.55) item = ITEMS[0];
    else if(r < 0.90) item = ITEMS[1]; // ‚≠ê
    else item = ITEMS[2]; // üëÆ

    const f = document.createElement("div");
    f.className = "falling";
    f.textContent = item.glyph;
    f.dataset.kind = item.kind;

    // corsia random (5)
    const laneIndex = Math.floor(Math.random() * LANES);
    f.dataset.lane = String(laneIndex);

    const w = arena.clientWidth;
    const laneW = w / LANES;
    const x = (laneIndex * laneW) + (laneW / 2);
    f.style.left = `${x - 48}px`;

    f.dataset.y = "-120";
    f.dataset.done = "0";

    inner.appendChild(f);
    falling.push(f);
  }

  function applyCollision(kind, hitX, hitY){
    bopPlayer();

    if(kind === "bad"){
      lives = Math.max(0, lives - 1);
      shakeArena();
      burst(hitX, hitY, ["#ff7a7a","#ffd34d","#ffffff","#6be6ff"]);
      if(lives <= 0){
        // restart soft (kid-friendly): reset vite e score un po' ridotto
        lives = 3;
        score = Math.floor(score * 0.6);
      }
      updateHud();
      return;
    }

    // good / bonus
    score += (kind === "bonus") ? 25 : 12;
    burst(hitX, hitY, (kind === "bonus")
      ? ["#ffd34d","#ff7bd6","#6be6ff","#ffffff"]
      : ["#ff9ad5","#7cffc6","#fff07a","#ffffff"]
    );

    // ‚≠ê d√† anche ‚Äúvita‚Äù ogni tot
    if(kind === "bonus" && lives < 5) lives += 1;

    updateLeveling();
    updateHud();
  }

  // ===== Loop =====
  let spawnAcc = 0;

  function tick(ts){
    if(!lastTs) lastTs = ts;
    const dt = Math.min(0.033, (ts - lastTs)/1000);
    lastTs = ts;

    if(!running){
      requestAnimationFrame(tick);
      return;
    }

    spawnAcc += dt * 1000;
    const cadence = spawnCadenceMs();
    while(spawnAcc >= cadence){
      spawnAcc -= cadence;
      spawnOne();
    }

    const fall = fallPxPerFrame();

    // linea collisione: sopra il pavimento
    const floorH = 170;
    const hitLine = arena.clientHeight - floorH - 70; // ‚Äúvicino al player‚Äù
    const missLine = arena.clientHeight + 220;

    for(let i = falling.length - 1; i >= 0; i--){
      const f = falling[i];
      const y = Number(f.dataset.y) + fall;
      f.dataset.y = String(y);
      f.style.transform = `translateY(${y}px)`;

      if(f.dataset.done === "0" && y >= hitLine && y <= hitLine + 48){
        const fLane = Number(f.dataset.lane);
        if(fLane === lane){
          f.dataset.done = "1";
          const rectA = arena.getBoundingClientRect();
          const rectF = f.getBoundingClientRect();
          const hitX = (rectF.left - rectA.left) + rectF.width/2;
          const hitY = (rectF.top - rectA.top) + rectF.height/2;

          applyCollision(f.dataset.kind, hitX, hitY);

          f.remove();
          falling.splice(i, 1);
          continue;
        }
      }

      if(y > missLine){
        f.remove();
        falling.splice(i, 1);
      }
    }

    requestAnimationFrame(tick);
  }

  // ===== Controlli: drag/swipe =====
  let pointerDown = false;

  function laneFromX(clientX){
    const rect = arena.getBoundingClientRect();
    const x = clientX - rect.left;
    const laneW = rect.width / LANES;
    return Math.max(0, Math.min(LANES-1, Math.floor(x / laneW)));
  }

  function setLane(newLane){
    lane = newLane;
    placePlayer();
  }

  // Triplo tap in basso per cambiare personaggio (bimba/coniglio) senza UI
  let taps = [];
  function handleTapForCharacter(e){
    const rect = arena.getBoundingClientRect();
    const y = e.clientY - rect.top;
    if(y < rect.height * 0.72) return;

    const now = performance.now();
    taps.push(now);
    taps = taps.filter(t => now - t < 650);
    if(taps.length >= 3){
      taps = [];
      setCharacter(charIndex + 1);
    }
  }

  arena.addEventListener("pointerdown", (e) => {
    pointerDown = true;
    arena.setPointerCapture?.(e.pointerId);
    setLane(laneFromX(e.clientX));
    handleTapForCharacter(e);
  });

  arena.addEventListener("pointermove", (e) => {
    if(!pointerDown) return;
    setLane(laneFromX(e.clientX));
  });

  arena.addEventListener("pointerup", () => { pointerDown = false; });
  arena.addEventListener("pointercancel", () => { pointerDown = false; });

  window.addEventListener("resize", placePlayer);

  // Desktop helper: H per HUD, 1/2 per personaggi
  window.addEventListener("keydown", (e) => {
    if(e.key.toLowerCase() === "h") toggleHud();
    if(e.key === "1") setCharacter(0);
    if(e.key === "2") setCharacter(1);
  });

  // INIT
  setCharacter(0);
  placePlayer();
  updateHud();
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
